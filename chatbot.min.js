// document.addEventListener("DOMContentLoaded", () => { const e = document.getElementById("chatContainer"), t = document.getElementById("chatMessages"), n = document.getElementById("userInput"), a = document.getElementById("sendButton"), s = document.getElementById("chatWidgetButton"), c = document.getElementById("closeButton"); function o(e, n = !1) { const a = document.createElement("div"); a.className = n ? "message user-message" : "message bot-message", a.innerHTML = `<p>${n ? e.replace(/\n/g, "<br>") : e}</p>`, t.appendChild(a), t.scrollTop = t.scrollHeight } async function i(e) { try { const t = await fetch("https://chatbot-q8b5.onrender.com/api/chat", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ input_value: e, output_type: "chat", input_type: "chat" }) }), n = await t.json(); return console.log("Data is:", n.result), "object" == typeof n.result && n.result && n.result[0].outputs[0].messages[0].message ? n.result[0].outputs[0].messages[0].message : n.result } catch (e) { return console.error("API Error:", e), "Oops! Something went wrong while contacting the server." } } function l(e) { const n = e.split("\n").filter(e => e.trim().startsWith("|")), a = []; for (let e = 2; e < n.length; e++) { const s = n[e].split("|").map(e => e.trim()), c = s[1]?.replace(/\*\*/g, "") || "", o = s[2]?.replace(/\*\*/g, "") || ""; c && o && a.push(`<strong>${c}</strong><br>${o}`) } return a.join("<br><br>") } async function d() { const e = n.value.trim(); if ("" !== e) { o(e, !0), n.value = ""; const a = document.createElement("div"); a.className = "message bot-message", a.innerHTML = "<p>Typing...</p>", t.appendChild(a), t.scrollTop = t.scrollHeight; const s = await i(e), c = l(s); t.removeChild(a), o(c) } } s.addEventListener("click", () => { e.classList.add("active"), n.focus() }), c.addEventListener("click", () => { e.classList.remove("active") }), a.addEventListener("click", d), n.addEventListener("keypress", e => { "Enter" === e.key && d() }) });

// document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("chatContainer"),t=document.getElementById("chatMessages"),n=document.getElementById("userInput"),a=document.getElementById("sendButton"),s=document.getElementById("chatWidgetButton"),c=document.getElementById("closeButton");function o(e,n=!1){const a=document.createElement("div");a.className=n?"message user-message":"message bot-message",a.innerHTML=`<p>${n?e.replace(/\n/g,"<br>"):e}</p>`,t.appendChild(a),t.scrollTop=t.scrollHeight}async function i(e){try{const a="https://chatbot-q8b5.onrender.com/api/chat";console.log("Sending request to:",a);const t=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({input_value:e,output_type:"chat",input_type:"chat"})}),n=await t.json();return console.log("Response received:",n),typeof n.result=="object"&&n.result?.[0]?.outputs?.[0]?.messages?.[0]?.message?n.result[0].outputs[0].messages[0].message:n.result}catch(e){return console.error("API Error:",e),"Oops! Something went wrong while contacting the server."}}function l(e){const n=e.split("\n").filter(e=>e.trim().startsWith("|")),a=[];for(let e=2;e<n.length;e++){const s=n[e].split("|").map(e=>e.trim()),c=s[1]?.replace(/\*\*/g,"")||"",o=s[2]?.replace(/\*\*/g,"")||"";c&&o&&a.push(`<strong>${c}</strong><br>${o}`)}return a.join("<br><br>")}async function d(){const e=n.value.trim();if(e!==""){o(e,!0),n.value="";const a=document.createElement("div");a.className="message bot-message",a.innerHTML="<p>Typing...</p>",t.appendChild(a),t.scrollTop=t.scrollHeight;const s=await i(e),c=l(s);t.removeChild(a),o(c)}}s.addEventListener("click",()=>{e.classList.add("active"),n.focus()}),c.addEventListener("click",()=>{e.classList.remove("active")}),a.addEventListener("click",d),n.addEventListener("keypress",e=>{"Enter"===e.key&&d()})});

// document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("chatContainer"),t=document.getElementById("chatMessages"),n=document.getElementById("userInput"),a=document.getElementById("sendButton"),s=document.getElementById("chatWidgetButton"),c=document.getElementById("closeButton");function o(e,n=!1){const a=document.createElement("div");a.className=n?"message user-message":"message bot-message",a.innerHTML=`<p>${n?e.replace(/\n/g,"<br>"):e}</p>`,t.appendChild(a),t.scrollTop=t.scrollHeight}async function i(e){try{const a="https://chatbot-q8b5.onrender.com/api/chat";console.log("Sending request to:",a);const t=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({input_value:e,output_type:"chat",input_type:"chat"})}),n=await t.json();return console.log("Response received:",n),typeof n.result=="object"&&n.result?.[0]?.outputs?.[0]?.messages?.[0]?.message?n.result[0].outputs[0].messages[0].message:n.result}catch(e){return console.error("API Error:",e),"Oops! Something went wrong while contacting the server."}}function l(e){const n=e.split("\n").filter(e=>e.trim().startsWith("|")),a=[];for(let e=2;e<n.length;e++){const s=n[e].split("|").map(e=>e.trim()),c=s[1]?.replace(/\*\*/g,"")||"",o=s[2]?.replace(/\*\*/g,"")||"";c&&o&&a.push(`<strong>${c}</strong><br>${o}`)}return a.join("<br><br>")}async function d(){const e=n.value.trim();if(e!==""){o(e,!0),n.value="";const a=document.createElement("div");a.className="message bot-message",a.innerHTML="<p>Typing...</p>",t.appendChild(a),t.scrollTop=t.scrollHeight;const s=await i(e);t.removeChild(a);let c;c=s&&s.trim().startsWith("|")?l(s):s;o(c)}}s.addEventListener("click",()=>{e.classList.add("active"),n.focus()}),c.addEventListener("click",()=>{e.classList.remove("active")}),a.addEventListener("click",d),n.addEventListener("keypress",e=>{"Enter"===e.key&&d()})});
document.addEventListener("DOMContentLoaded", () => {
    const chatContainer = document.getElementById("chatContainer"),
          chatMessages = document.getElementById("chatMessages"),
          userInput = document.getElementById("userInput"),
          sendButton = document.getElementById("sendButton"),
          chatWidgetButton = document.getElementById("chatWidgetButton"),
          closeButton = document.getElementById("closeButton");

    function addMessage(message, isUser = false) {
        const messageDiv = document.createElement("div");
        messageDiv.className = isUser ? "message user-message" : "message bot-message";
        messageDiv.innerHTML = `<p>${message}</p>`;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function callAPI(inputText) {
        try {
            const apiUrl = "https://chatbot-q8b5.onrender.com/api/chat";
            const response = await fetch(apiUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    input_value: inputText,
                    output_type: "chat",
                    input_type: "chat"
                }),
            });
            const data = await response.json();
            return typeof data.result == "object" && data.result?.[0]?.outputs?.[0]?.messages?.[0]?.message
                ? data.result[0].outputs[0].messages[0].message
                : data.result;
        } catch (error) {
            console.error("API Error:", error);
            return "Oops! Something went wrong while contacting the server.";
        }
    }

    function convertToTable(text) {
        const lines = text.trim().split("\n").filter(line => line.startsWith("|"));
        if (lines.length === 0) return text;

        let tableHTML = "<table style='width: 100%; border-collapse: collapse; border: 1px solid #ccc;'>";

        // Headers
        tableHTML += "<thead><tr>";
        const headers = lines[0].split("|").filter(h => h.trim() !== "").map(h => h.trim());
        headers.forEach(header => {
            tableHTML += `<th style='border: 1px solid #ccc; padding: 8px; text-align: left; background-color: #f2f2f2;'>${header}</th>`;
        });
        tableHTML += "</tr></thead>";

        // Rows
        tableHTML += "<tbody>";
        for (let i = 2; i < lines.length; i++) {
            const row = lines[i].split("|").filter(cell => cell.trim() !== "").map(cell => cell.trim());
            tableHTML += "<tr>";
            row.forEach(cell => {
                tableHTML += `<td style='border: 1px solid #ccc; padding: 8px;'>${cell.replace(/\*\*/g, "")}</td>`;
            });
            tableHTML += "</tr>";
        }
        tableHTML += "</tbody>";

        tableHTML += "</table>";
        return tableHTML;
    }

    async function handleSend() {
        const text = userInput.value.trim();
        if (text !== "") {
            addMessage(text, true);
            userInput.value = "";
            const loading = document.createElement("div");
            loading.className = "message bot-message";
            loading.innerHTML = "<p>Typing...</p>";
            chatMessages.appendChild(loading);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            const botReply = await callAPI(text);
            chatMessages.removeChild(loading);

            const finalReply = botReply && botReply.trim().startsWith("|") ? convertToTable(botReply) : botReply;
            addMessage(finalReply);
        }
    }

    chatWidgetButton.addEventListener("click", () => {
        chatContainer.classList.add("active");
        userInput.focus();
    });

    closeButton.addEventListener("click", () => {
        chatContainer.classList.remove("active");
    });

    sendButton.addEventListener("click", handleSend);

    userInput.addEventListener("keypress", e => {
        if (e.key === "Enter") {
            handleSend();
        }
    });
});
